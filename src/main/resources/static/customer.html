<!DOCTYPE html>
<html>
<head>
    <title>Customer Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>Customer Chat</h2>
<div id="chat">
    <div id="messages"></div>
    <input type="text" id="messageInput">
    <button onclick="sendMessage()">Send Message</button>
    <button onclick="sendChatStartRequest()">Start Chat Request</button>
    <button onclick="sendChatStartResponse()">Start Chat Response</button>
    <button onclick="sendChatFinishRequest()">End Chat</button>
</div>

<script type="text/javascript">
    var stompClient = null;
    var chatId = 3; // 채팅방 ID로 업데이트
    var token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhYWFAZ21haWwuY29tIiwiYXV0aG9yaXRpZXMiOiJST0xFX0NVU1RPTUVSIiwiZXhwIjoxNzA1NTkxMDExfQ.6K3po9TiIKmU8N3qrpHI8mFms5-DdEZd6W05Q8--nGM"; // 인증 토큰
    var isCustomer = true; // 고객 여부

    function connect() {
        var socket = new SockJS('/chat'); // 서버의 웹소켓 연결 주소
        stompClient = Stomp.over(socket);
        stompClient.connect({
            'Authorization': 'Bearer ' + token,
            'isCustomer': isCustomer
        }, function (frame) {
            console.log('Connected: ' + frame);

            // 구독
            stompClient.subscribe('/queue/chattings/notifications/customers/1', function (notification) {//데모 테스트 때, 여기 userId를 customerId로 바꾸어주면 됨
                console.log('Notification: ', notification.body);
            });
            stompClient.subscribe('/queue/chattings/customers/' + chatId, function (statusUpdate) {
                console.log('Status Update: ', statusUpdate.body);
            });
            stompClient.subscribe('/queue/chattings/status/customers/' + chatId, function (statusAutoUpdate) {
                console.log('Status Auto Update: ', statusAutoUpdate.body);
            });
        stompClient.subscribe('/queue/chattings/exception/customers/' + chatId, function (error) {
            console.log('error: ', error.body);
        });
            stompClient.subscribe('/queue/chatMessages/customers/' + chatId, function (message) {
                console.log('Message: ', message.body);
                displayMessage(message.body);
            });
        });
    }

    function sendMessage() {
        var message = document.getElementById('messageInput').value;
        stompClient.send("/app/api/v1/chatMessages/customers/" + chatId, {}, JSON.stringify({content: message}));
    }

    function sendChatStartRequest() {
        stompClient.send("/app/api/v1/chat/customers/" + chatId, {}, JSON.stringify({chatWebsocketStatus: "COUNSELOR_CHAT_START_REQUEST"}));
    }

    function sendChatStartResponse() {
        stompClient.send("/app/api/v1/chat/customers/" + chatId, {}, JSON.stringify({chatWebsocketStatus: "CUSTOMER_CHAT_START_RESPONSE"}));
    }

    function sendChatFinishRequest() {
        stompClient.send("/app/api/v1/chat/customers/" + chatId, {}, JSON.stringify({chatWebsocketStatus: "CUSTOMER_CHAT_FINISH_REQUEST"}));
    }

    function displayMessage(message) {
        var messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += '<div>' + message + '</div>';
    }

    connect();
</script>
</body>
</html>
